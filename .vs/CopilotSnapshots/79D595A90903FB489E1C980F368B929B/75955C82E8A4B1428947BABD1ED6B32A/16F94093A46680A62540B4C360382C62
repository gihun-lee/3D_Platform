using System.Numerics;
using VPP.Core.Attributes;
using VPP.Core.Models;
using VPP.Plugins.PointCloud.Models;
using ExecutionContext = VPP.Core.Models.ExecutionContext;

namespace VPP.Plugins.PointCloud.Nodes;

[NodeInfo("Rigid Transform", "Point Cloud/Transform", "Apply 4x4 rigid transform matrix to point cloud (rotation+translation)")]
public class RigidTransformNode : NodeBase
{
    public RigidTransformNode()
    {
        // Single 4x4 matrix parameter (row-major). Identity default.
        AddParameter<Matrix4x4>("Matrix", Matrix4x4.Identity, required:false, displayName:"Matrix", description:"4x4 transform matrix (row-major). Translation in M14,M24,M34.");
    }

    protected override Task ExecuteCoreAsync(ExecutionContext context, CancellationToken cancellationToken)
    {
        var source = context.Get<PointCloudData>(ExecutionContext.FilteredCloudKey) ??
                     context.Get<PointCloudData>(ExecutionContext.PointCloudKey);
        if (source == null || source.Points.Count == 0)
            return Task.CompletedTask;

        var m = GetParameter<Matrix4x4>("Matrix");

        var result = source.Clone();
        for (int i = 0; i < result.Points.Count; i++)
        {
            var p = result.Points[i];
            var x = m.M11 * p.X + m.M12 * p.Y + m.M13 * p.Z + m.M14;
            var y = m.M21 * p.X + m.M22 * p.Y + m.M23 * p.Z + m.M24;
            var z = m.M31 * p.X + m.M32 * p.Y + m.M33 * p.Z + m.M34;
            result.Points[i] = new Vector3(x, y, z);
        }
        result.ComputeBoundingBox();

        context.Set(ExecutionContext.FilteredCloudKey, result);
        // Also store matrix for downstream nodes if needed
        context.Set("RigidTransformMatrix", m);
        return Task.CompletedTask;
    }
}
