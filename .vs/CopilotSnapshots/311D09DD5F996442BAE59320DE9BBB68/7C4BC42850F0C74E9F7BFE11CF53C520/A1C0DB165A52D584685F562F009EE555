using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Shapes;
using VPP.App.ViewModels;
using VPP.Core.Interfaces;

namespace VPP.App.Views;

public partial class MainWindow : Window
{
    private MainViewModel? ViewModel => DataContext as MainViewModel;

    // Node dragging state
    private bool _isDraggingNode;
    private NodeViewModel? _draggedNode;
    private System.Windows.Point _nodeStartPosition;
    private System.Windows.Point _mouseStartPosition;

    // Context menu position
    private System.Windows.Point _contextMenuPosition;

    public MainWindow()
    {
        InitializeComponent();

        NodeCanvas.MouseMove += NodeCanvas_MouseMove;
        NodeCanvas.MouseLeftButtonUp += NodeCanvas_MouseLeftButtonUp;
    }

    #region Context Menu

    private void NodeCanvas_MouseRightButtonDown(object sender, MouseButtonEventArgs e)
    {
        _contextMenuPosition = e.GetPosition(NodeCanvas);
    }

    private void AddNodeContextMenu_Opened(object sender, RoutedEventArgs e)
    {
        if (ViewModel != null)
        {
            ViewModel.NodeSearchText = "";
            ViewModel.UpdateFilteredNodes();
        }
    }

    private void NodeSearchBox_TextChanged(object sender, TextChangedEventArgs e)
    {
        ViewModel?.UpdateFilteredNodes();
    }

    private void NodeListBox_KeyDown(object sender, KeyEventArgs e)
    {
        if (e.Key == Key.Enter)
            AddSelectedNode(sender as ListBox);
    }

    private void NodeListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        if (sender is ListBox listBox && listBox.SelectedItem != null)
            AddSelectedNode(listBox);
    }

    private void AddSelectedNode(ListBox? listBox)
    {
        if (listBox?.SelectedItem is string nodeType && ViewModel != null)
        {
            ViewModel.AddNodeAtPosition(nodeType, _contextMenuPosition.X, _contextMenuPosition.Y);
            AddNodeContextMenu.IsOpen = false;
        }
    }

    #endregion

    #region Node Dragging

    private void Node_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
    {
        if (sender is Border border && border.DataContext is NodeViewModel nodeVm)
        {
            if (e.OriginalSource is Ellipse)
                return;

            if (nodeVm.Name == "Import Point Cloud")
            {
                var dialog = new Microsoft.Win32.OpenFileDialog
                {
                    Filter = "Point Cloud Files|*.ply;*.pcd;*.xyz;*.csv;*.txt|All Files|*.*",
                    Title = "Select Point Cloud File"
                };

                if (dialog.ShowDialog() == true)
                {
                    // Use parameter-based system instead of ports
                    var pathParam = nodeVm.Node.Parameters.FirstOrDefault(p => p.Name == "FilePath");
                    if (pathParam != null)
                    {
                        pathParam.Value = dialog.FileName;

                        if (ViewModel != null)
                            ViewModel.StatusMessage = $"Selected: {System.IO.Path.GetFileName(dialog.FileName)}";
                    }
                }
                e.Handled = true;
                return;
            }

            _isDraggingNode = true;
            _draggedNode = nodeVm;
            _nodeStartPosition = new System.Windows.Point(nodeVm.X, nodeVm.Y);
            _mouseStartPosition = e.GetPosition(NodeCanvas);
            border.CaptureMouse();
            e.Handled = true;
        }
    }

    private void Node_MouseMove(object sender, MouseEventArgs e)
    {
        if (_isDraggingNode && _draggedNode != null && e.LeftButton == MouseButtonState.Pressed)
        {
            var currentPos = e.GetPosition(NodeCanvas);
            var delta = currentPos - _mouseStartPosition;

            _draggedNode.X = _nodeStartPosition.X + delta.X;
            _draggedNode.Y = _nodeStartPosition.Y + delta.Y;

            ViewModel?.UpdateConnectionPositions();
            e.Handled = true;
        }
    }

    private void Node_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)
    {
        if (_isDraggingNode && sender is Border border)
        {
            _isDraggingNode = false;
            _draggedNode = null;
            border.ReleaseMouseCapture();
            e.Handled = true;
        }
    }

    private void NodeCanvas_MouseMove(object sender, MouseEventArgs e)
    {
        // Mouse move handling for canvas
    }

    private void NodeCanvas_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)
    {
        // Mouse up handling for canvas
    }

    #endregion
}
