using System.Globalization;
using System.Numerics;
using System.Windows;

namespace VPP.App.Views;

public partial class MatrixEditWindow : Window
{
    public Matrix4x4 ResultMatrix { get; private set; } = Matrix4x4.Identity;

    public MatrixEditWindow() : this(Matrix4x4.Identity) { }

    public MatrixEditWindow(Matrix4x4 initial)
    {
        InitializeComponent();
        SetFields(initial);
        ResultMatrix = initial;
    }

    private void SetFields(Matrix4x4 m)
    {
        M11.Text = m.M11.ToString(CultureInfo.InvariantCulture); M12.Text = m.M12.ToString(CultureInfo.InvariantCulture); M13.Text = m.M13.ToString(CultureInfo.InvariantCulture); M14.Text = m.M14.ToString(CultureInfo.InvariantCulture);
        M21.Text = m.M21.ToString(CultureInfo.InvariantCulture); M22.Text = m.M22.ToString(CultureInfo.InvariantCulture); M23.Text = m.M23.ToString(CultureInfo.InvariantCulture); M24.Text = m.M24.ToString(CultureInfo.InvariantCulture);
        M31.Text = m.M31.ToString(CultureInfo.InvariantCulture); M32.Text = m.M32.ToString(CultureInfo.InvariantCulture); M33.Text = m.M33.ToString(CultureInfo.InvariantCulture); M34.Text = m.M34.ToString(CultureInfo.InvariantCulture);
        M41.Text = m.M41.ToString(CultureInfo.InvariantCulture); M42.Text = m.M42.ToString(CultureInfo.InvariantCulture); M43.Text = m.M43.ToString(CultureInfo.InvariantCulture); M44.Text = m.M44.ToString(CultureInfo.InvariantCulture);
    }

    private bool TryParse(out Matrix4x4 m)
    {
        float m11=0,m12=0,m13=0,m14=0,
              m21=0,m22=0,m23=0,m24=0,
              m31=0,m32=0,m33=0,m34=0,
              m41=0,m42=0,m43=0,m44=0;

        // Use single '&' (non short-circuit) to ensure all parses are attempted
        bool ok =
            float.TryParse(M11.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m11) &
            float.TryParse(M12.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m12) &
            float.TryParse(M13.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m13) &
            float.TryParse(M14.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m14) &
            float.TryParse(M21.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m21) &
            float.TryParse(M22.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m22) &
            float.TryParse(M23.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m23) &
            float.TryParse(M24.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m24) &
            float.TryParse(M31.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m31) &
            float.TryParse(M32.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m32) &
            float.TryParse(M33.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m33) &
            float.TryParse(M34.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m34) &
            float.TryParse(M41.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m41) &
            float.TryParse(M42.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m42) &
            float.TryParse(M43.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m43) &
            float.TryParse(M44.Text, NumberStyles.Float, CultureInfo.InvariantCulture, out m44);

        m = new Matrix4x4(m11,m12,m13,m14,m21,m22,m23,m24,m31,m32,m33,m34,m41,m42,m43,m44);
        return ok;
    }

    private void Ok_Click(object sender, RoutedEventArgs e)
    {
        if (TryParse(out var mat))
        {
            ResultMatrix = mat;
            DialogResult = true;
        }
        else
        {
            MessageBox.Show("Invalid numeric value", "Matrix", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private void Cancel_Click(object sender, RoutedEventArgs e)
    {
        DialogResult = false;
    }

    private void Identity_Click(object sender, RoutedEventArgs e)
    {
        SetFields(Matrix4x4.Identity);
    }
}
