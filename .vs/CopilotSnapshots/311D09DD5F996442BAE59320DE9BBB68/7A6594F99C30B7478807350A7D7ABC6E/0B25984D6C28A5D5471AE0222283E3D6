using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Shapes;
using VPP.App.ViewModels;
using VPP.Core.Interfaces;

namespace VPP.App.Views;

public partial class MainWindow : Window
{
    private MainViewModel? ViewModel => DataContext as MainViewModel;

    // Connection dragging state
    private bool _isDraggingConnection;
    private IPort? _dragStartPort;
    private bool _isOutputPort;
    private System.Windows.Point _dragStartPoint;
    private NodeViewModel? _dragStartNode;

    // Node dragging state
    private bool _isDraggingNode;
    private NodeViewModel? _draggedNode;
    private System.Windows.Point _nodeStartPosition;
    private System.Windows.Point _mouseStartPosition;

    // Context menu position
    private System.Windows.Point _contextMenuPosition;

    public MainWindow()
    {
        InitializeComponent();

        NodeCanvas.MouseMove += NodeCanvas_MouseMove;
        NodeCanvas.MouseLeftButtonUp += NodeCanvas_MouseLeftButtonUp;
    }

    #region Context Menu

    private void NodeCanvas_MouseRightButtonDown(object sender, MouseButtonEventArgs e)
    {
        _contextMenuPosition = e.GetPosition(NodeCanvas);
    }

    private void AddNodeContextMenu_Opened(object sender, RoutedEventArgs e)
    {
        if (ViewModel != null)
        {
            ViewModel.NodeSearchText = "";
            ViewModel.UpdateFilteredNodes();
        }
    }

    private void NodeSearchBox_TextChanged(object sender, TextChangedEventArgs e)
    {
        ViewModel?.UpdateFilteredNodes();
    }

    private void NodeListBox_KeyDown(object sender, KeyEventArgs e)
    {
        if (e.Key == Key.Enter)
            AddSelectedNode(sender as ListBox);
    }

    private void NodeListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        if (sender is ListBox listBox && listBox.SelectedItem != null)
            AddSelectedNode(listBox);
    }

    private void AddSelectedNode(ListBox? listBox)
    {
        if (listBox?.SelectedItem is string nodeType && ViewModel != null)
        {
            ViewModel.AddNodeAtPosition(nodeType, _contextMenuPosition.X, _contextMenuPosition.Y);
            AddNodeContextMenu.IsOpen = false;
        }
    }

    #endregion

    #region Node Dragging

    private void Node_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
    {
        if (sender is Border border && border.DataContext is NodeViewModel nodeVm)
        {
            if (e.OriginalSource is Ellipse)
                return;

            if (nodeVm.Name == "Import Point Cloud")
            {
                var dialog = new Microsoft.Win32.OpenFileDialog
                {
                    Filter = "Point Cloud Files|*.ply;*.pcd;*.xyz;*.csv;*.txt|All Files|*.*",
                    Title = "Select Point Cloud File"
                };

                if (dialog.ShowDialog() == true)
                {
                    var pathPort = nodeVm.Node.InputPorts.FirstOrDefault(p => p.Name == "FilePath");
                    if (pathPort != null)
                    {
                        pathPort.Value = dialog.FileName;

                        if (ViewModel != null)
                            ViewModel.StatusMessage = $"Selected: {System.IO.Path.GetFileName(dialog.FileName)}";
                    }
                }
                e.Handled = true;
                return;
            }

            _isDraggingNode = true;
            _draggedNode = nodeVm;
            _nodeStartPosition = new System.Windows.Point(nodeVm.X, nodeVm.Y);
            _mouseStartPosition = e.GetPosition(NodeCanvas);
            border.CaptureMouse();
            e.Handled = true;
        }
    }

    private void Node_MouseMove(object sender, MouseEventArgs e)
    {
        if (_isDraggingNode && _draggedNode != null && e.LeftButton == MouseButtonState.Pressed)
        {
            var currentPos = e.GetPosition(NodeCanvas);
            var delta = currentPos - _mouseStartPosition;

            _draggedNode.X = _nodeStartPosition.X + delta.X;
            _draggedNode.Y = _nodeStartPosition.Y + delta.Y;

            ViewModel?.UpdateConnectionPositions();
            e.Handled = true;
        }
    }

    private void Node_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)
    {
        if (_isDraggingNode && sender is Border border)
        {
            _isDraggingNode = false;
            _draggedNode = null;
            border.ReleaseMouseCapture();
            e.Handled = true;
        }
    }

    #endregion

    #region Port Connection Dragging

    private void OutputPort_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
    {
        if (sender is Ellipse ellipse && ellipse.Tag is IPort port)
        {
            StartConnectionDrag(ellipse, port, true);
            e.Handled = true;
        }
    }

    private void InputPort_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
    {
        if (sender is Ellipse ellipse && ellipse.Tag is IPort port)
        {
            StartConnectionDrag(ellipse, port, false);
            e.Handled = true;
        }
    }

    private void StartConnectionDrag(Ellipse ellipse, IPort port, bool isOutput)
    {
        _isDraggingConnection = true;
        _dragStartPort = port;
        _isOutputPort = isOutput;
        _dragStartPoint = ellipse.TranslatePoint(new System.Windows.Point(5, 5), NodeCanvas);

        var parent = VisualTreeHelper.GetParent(ellipse);
        while (parent != null)
        {
            if (parent is Border border && border.DataContext is NodeViewModel nodeVm)
            {
                _dragStartNode = nodeVm;
                break;
            }
            parent = VisualTreeHelper.GetParent(parent);
        }

        TempConnectionLine.Visibility = Visibility.Visible;
        UpdateTempConnectionLine(_dragStartPoint);
        NodeCanvas.CaptureMouse();
    }

    private void NodeCanvas_MouseMove(object sender, MouseEventArgs e)
    {
        if (_isDraggingConnection)
        {
            var currentPos = e.GetPosition(NodeCanvas);
            UpdateTempConnectionLine(currentPos);
        }
    }

    private void UpdateTempConnectionLine(System.Windows.Point endPoint)
    {
        var geometry = new PathGeometry();
        var figure = new PathFigure { StartPoint = _dragStartPoint };

        var controlOffset = Math.Abs(endPoint.X - _dragStartPoint.X) / 2;
        var control1 = _isOutputPort
            ? new System.Windows.Point(_dragStartPoint.X + controlOffset, _dragStartPoint.Y)
            : new System.Windows.Point(_dragStartPoint.X - controlOffset, _dragStartPoint.Y);
        var control2 = _isOutputPort
            ? new System.Windows.Point(endPoint.X - controlOffset, endPoint.Y)
            : new System.Windows.Point(endPoint.X + controlOffset, endPoint.Y);

        figure.Segments.Add(new BezierSegment(control1, control2, endPoint, true));
        geometry.Figures.Add(figure);
        TempConnectionLine.Data = geometry;
    }

    private void NodeCanvas_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)
    {
        if (_isDraggingConnection)
        {
            TempConnectionLine.Visibility = Visibility.Collapsed;
            NodeCanvas.ReleaseMouseCapture();
            _isDraggingConnection = false;
            _dragStartPort = null;
            _dragStartNode = null;
        }
    }

    private void Port_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)
    {
        if (_isDraggingConnection && sender is Ellipse ellipse && ellipse.Tag is IPort targetPort)
        {
            NodeViewModel? targetNode = null;
            var parent = VisualTreeHelper.GetParent(ellipse);
            while (parent != null)
            {
                if (parent is Border border && border.DataContext is NodeViewModel nodeVm)
                {
                    targetNode = nodeVm;
                    break;
                }
                parent = VisualTreeHelper.GetParent(parent);
            }

            if (targetNode != null && _dragStartNode != null && _dragStartPort != null)
            {
                if (_isOutputPort && targetPort.Direction == PortDirection.Input)
                    ViewModel?.CreateConnection(_dragStartNode, _dragStartPort, targetNode, targetPort);
                else if (!_isOutputPort && targetPort.Direction == PortDirection.Output)
                    ViewModel?.CreateConnection(targetNode, targetPort, _dragStartNode, _dragStartPort);
            }

            TempConnectionLine.Visibility = Visibility.Collapsed;
            NodeCanvas.ReleaseMouseCapture();
            _isDraggingConnection = false;
            _dragStartPort = null;
            _dragStartNode = null;
            e.Handled = true;
        }
    }

    #endregion
}
